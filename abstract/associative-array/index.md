---
title: 連想配列
description: キーで値を即座に参照できる抽象データ構造と設計指針
---

## 概要
連想配列はキーと値の組を保持し、キーを指定して値へ直接アクセスできる抽象データ構造である。配列やリストのように位置ではなく識別子で参照するため、設定情報や名前付き引数、キャッシュなど意味を持つデータを管理するのに向く。

## 特徴と設計指針
- **キーの一意性**: 既存キーに再度代入すると多くの実装で上書きとなる。重複が必要な場合は値側に配列を持たせるか名前空間を含めた複合キーを採用する。
- **アクセス計算量**: ハッシュマップなら平均 O(1)、木構造なら O(log n)。順序保証や範囲検索が必要かによって実装を選ぶ。
- **キー比較の定義**: 参照型キーでは同一インスタンス性、値型キーでは値比較ルールを仕様に明示する。
- **順序保証**: 追加順を維持する実装としない実装が混在する。順序に依存する処理を書く場合は保証の有無を明文化する。

## 作成方法
| 方法 | 説明 | 疑似コード |
| --- | --- | --- |
| リテラル | 小規模データを即座に定義 | `設定 = { "言語"→"ja", "テーマ"→"dark" }` |
| 空の連想配列から構築 | 後から段階的に値を設定 | `ユーザー = 新しい連想配列()`<br>`ユーザー.設定("名前", "藍")` |
| ペア列から生成 | DB 結果や設定ファイルを変換 | `環境 = 連想配列に変換([ ("HOST","example"), ("PORT",443) ])` |

## 基本操作
```pseudo
設定 = 新しい連想配列()
設定.代入(キー: "timezone", 値: "UTC+9")
設定.代入("timezone", "UTC+9")  # 同じキーを上書き
もし 設定.存在("timezone") なら:
    表示(設定.取得("timezone"))
設定.削除("timezone")
```
- `代入`: 新規キーなら追加、既存キーなら値を更新。
- `取得`: 見つからない場合の挙動（`null`、`未定義`、例外など）を仕様として決めておく。
- `存在`: 値が `null` の場合と未定義キーを区別できる API が望ましい。
- `削除`: 存在したかどうかを真偽値で返すとエラーハンドリングしやすい。

## 反復処理と順序制御
```pseudo
設定 = { "host"→"db", "port"→5432, "ssl"→真 }

キー一覧 = 設定.キー列挙()
for 各キー in キー一覧:
    表示(キー)

for (キー, 値) in 設定.ペア列挙(順序: 追加順):
    表示("%s=%s" % (キー, 値))
```
- 列挙時の順序と途中更新の扱いを定義する。スナップショットを取得するか、列挙中は変更を禁止すると安全。

## 応用パターン
### ネスト構造
```pseudo
プロファイル = {
    "id" → 120,
    "contact" → { "email"→"dev@example.com", "phone"→null },
    "tags" → ["speaker", "mentor"],
}
```
- 深いパスを安全に辿るために `安全取得("contact.email")` のようなユーティリティを用意する。

### 既定値のマージ
```pseudo
既定 = { "表示件数"→20 }
入力 = {}
マージ後 = 既定.コピー()
for (キー, 値) in 入力.ペア列挙():
    マージ後.代入(キー, 値)
```
- 浅いコピーか深いコピーかを使用者に明示する。参照共有すると副作用が伝染するため注意。

### シリアライズ
- テキスト化する場合はキー順序の扱いを決め（例: 追加順、キー名ソート）、受信側で同じ規則を適用する。
- バイナリ形式ではキーを ID に置き換えて圧縮する最適化も可能。

## 代表的な落とし穴
1. **可変オブジェクトキーの変更**: 参照型キーの状態を後から変えると検索に失敗する実装がある。複雑なオブジェクトをキーに使う際はイミュータブル化する。
2. **順序保証への依存**: ハッシュマップがたまたま順序を保つことに依存すると移植性が失われる。順序付き構造が必要なら初めから選択する。
3. **文字列化による衝突**: 内部でキーを文字列に変換する実装では `1` と `"1"` を区別できない。厳密な型区別が必要なら別構造を採用する。

## 関連トピック
- `abstract/key-existence/index.md`: キーの存在確認の扱い
- `abstract/associative-array-deletion/index.md`: エントリ削除の戦略
- `abstract/value-enumeration/index.md`: 値列挙と分析
