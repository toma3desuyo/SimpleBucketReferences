---
title: 非同期の待機
description: 非同期タスクの完了を待ち合わせる手法
---

## 概要
非同期待機は、進行中のタスクが完了するまで制御を一時停止し、結果を受け取る仕組みである。明示的に待機することで順序性が必要な箇所だけ同期を確保し、他の部分では並行性を維持する。

## 待機方法
- **await/待機式**: フューチャーが完了するまで一時停止し、再開時に結果を返す。
- **コールバック登録**: 完了ハンドラを渡し、結果をイベントとして受け取る。
- **一括待機**: `すべて待機(配列)` や `いずれか完了` などのユーティリティで複数タスクを制御する。

## 基本例
```pseudo
データ = await 読み込み()
加工結果 = 処理(データ)
await 保存(加工結果)
```
- 待機ポイントでは現在のコンテキストが一旦抜ける。排他ロックを持ったまま待機しないよう設計する。

## 応用パターン
### タイムアウト付き待機
```pseudo
(成功, 値) = await 待機またはタイムアウト(操作, 期限: 2秒)
もし 成功 なら 利用する
そうでなければ フォールバック()
```
- 一定時間で諦め、キャンセル信号を発してリソース浪費を防ぐ。

### 並列待機
```pseudo
タスク群 = [呼び出しA(), 呼び出しB(), 呼び出しC()]
結果一覧 = await すべて完了(タスク群)
```
- 互いに独立したタスクはまとめて待機し、エラー時の部分成功をどう扱うかルールを決める。

## 注意点
1. **デッドロック**: シングルスレッドのイベントループで同期的に完了を待つと停止する。必ずノンブロッキングな待機手段を使う。
2. **コンテキスト切り替えコスト**: 待機を細かく挟みすぎると再開処理のオーバーヘッドが増える。I/O 境界に絞る。
3. **例外の再スロー**: 待機したタスクが失敗した場合、待機地点で例外が再スローされる。適切に捕捉して再試行や代替処理を行う。

## 関連トピック
- `abstract/async-processing/index.md`: 非同期処理の全体像
- `abstract/callback-function/index.md`: 完了ハンドラ
- `abstract/exception-handling/index.md`: 非同期例外処理
